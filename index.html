<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIFT SCHEDULE 2026</title>
    <style>
            :root { --header-height: 64px; }

        /* header layout: left = nav, center = filters, right = download */
        .header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.05);
            flex-wrap: nowrap;
        }

        /* left navigation group */
        .navigation {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-left: 0.25rem;
        }

        /* center filters - keep centered in header */
        .filters {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            justify-self: center;
            height: 100%;
        }

        /* right download area */
        .download-area {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.25rem;
        }

        .download-button {
            padding: 0.45rem 0.8rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 700;
            transition: background 0.2s;
        }
        .download-button:hover { background: #059669; }

        /* keep calendar columns aligned and weekday header sticky below .header */
        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* ensures fixed column widths so header aligns with body */
        }

        .calendar thead th {
            position: sticky;
            top: calc(var(--header-height)); /* offset by header height */
            z-index: 35;
            background: #667eea; /* keep original header background */
            color: white;
        }
        /* ensure equal column widths */
        .calendar th, .calendar td { width: calc(100% / 7); }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            overflow-y: scroll;
        }

        .container {
            max-width: 90rem;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.3);
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        .nav-button {
            padding: 0.45rem 0.6rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background: #5568d3;
        }

        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .month-year {
            font-size: 1.25rem;
            font-weight: bold;
            color: #333;
            text-align: center;
            min-width: 10rem;
        }

        /* Dropdown filter styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-button {
            padding: 0.45rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid #ccc;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.08);
            border-radius: 0.4rem;
            padding: 0.25rem;
            margin-top: 0.4rem;
            display: none;
            z-index: 20;
            min-width: 9rem;
            overflow: auto;
        }
        .dropdown.open .dropdown-menu { display: block; }
        .dropdown-item {
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            border-radius: 0.25rem;
        }
        .dropdown-item:hover { background: #f1f5f9; }
        /* tick as square box on the left */
        .dropdown-item .tick {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #cbd5e1;
            background: #fff;
            color: transparent; /* hide check when not selected */
            margin-right: 0.8rem;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        .dropdown-item.selected .tick {
            background: #2b6cb0;
            border-color: #2b6cb0;
            color: #fff; /* show check in white when selected */
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar th {
            background: #667eea;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
        }

        .calendar td {
            border: 0.0625rem solid #ddd;
            padding: 0.5rem;
            vertical-align: top;
            min-height: 8rem;
            width: 14.28%;
        }

        .day-number {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
            text-align: center;
        }

        .team-schedule {
            margin-bottom: 0.3rem;
            padding: 0.3rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .team-name {
            font-weight: bold;
            display: block;
        }

        .shift-time {
            font-size: 0.7rem;
            display: block;
        }

        /* Shift colors */
        .shift-0000-0800 {
            background: #4a5568;
            color: white;
        }

        .shift-0800-1600 {
            background: #48bb78;
            color: white;
        }

        .shift-1600-0000 {
            background: #ed8936;
            color: white;
        }

        .shift-off {
            background: #e2e8f0;
            color: #4a5568;
        }

        .shift-rest {
            background: #e2e8f0;
            color: #4a5568;
        }

        .empty-day {
            background: #f7fafc;
        }

        /* Responsive design */
        @media (max-width: 48rem) {
            .month-year {
                font-size: 1.1rem;
            }

            .nav-button {
                padding: 0.5rem 0.8rem;
                font-size: 0.9rem;
            }

            .calendar th {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            .calendar td {
                padding: 0.3rem;
                font-size: 0.7rem;
            }

            .day-number {
                font-size: 0.9rem;
                margin-bottom: 0.3rem;
            }

            .team-schedule {
                padding: 0.2rem;
                margin-bottom: 0.2rem;
                font-size: 0.65rem;
            }

            .shift-time {
                font-size: 0.6rem;
            }
            .download-button { padding: 0.35rem 0.6rem; font-size: 0.85rem; }
        }

        @media (max-width: 30rem) {
            .container {
                padding: 0.75rem;
            }

            /* stack header groups on very small screens */
            .header {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .navigation, .filters, .download-area { justify-content: center; padding: 0; }
            .team-schedule {
                font-size: 0.55rem;
                padding: 0.15rem;
            }

            .shift-time {
                font-size: 0.5rem;
            }
        }

        /* Modal: download confirmation */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal.open { display: flex; }
        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(1px);
        }
        .modal-content {
            position: relative;
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            max-width: 28rem;
            width: calc(100% - 2rem);
            box-shadow: 0 1rem 3rem rgba(0,0,0,0.35);
            z-index: 65;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .modal-content h3 { 
            margin: 0;
            font-size: 1.05rem; 
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: background 0.2s, color 0.2s;
        }
        .modal-close:hover {
            background: #f3f4f6;
            color: #111827;
        }
        .modal-close:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-body { color: #111827; font-size: 0.95rem; margin-bottom: 0.75rem; }
        
        /* Loading spinner */
        .modal-loading {
            display: none;
            text-align: center;
            padding: 2rem 1rem;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .modal-loading.active { display: flex; }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-loading p {
            margin: 0;
            color: #4b5563;
            font-size: 0.95rem;
        }
        .modal-confirm, .modal-actions {
            display: block;
        }
        .modal-confirm.hidden, .modal-actions.hidden {
            display: none;
        }

        /* Loading spinner overlay - above modal */
    .spinner-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 70;
        background: rgba(0, 0, 0, 0.3);
    }
    .spinner-overlay.active { display: flex; }
    .spinner-container {
        background: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 1rem 3rem rgba(0,0,0,0.35);
        text-align: center;
        min-width: 300px;
    }
    .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner-overlay p {
        margin: 0;
        color: #4b5563;
        font-size: 0.95rem;
    }
    
    /* Modal loading view - hidden now */
    .modal-loading {
        display: none;
    }
        </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- left: prev, current month, next -->
            <div class="navigation" aria-label="month navigation">
                <button class="nav-button" id="prevBtn" onclick="changeMonth(-1)"></button>
                <div class="month-year" id="monthYear"></div>
                <button class="nav-button" id="nextBtn" onclick="changeMonth(1)"></button>
            </div>

            <!-- center: filters -->
            <div class="filters" role="region" aria-label="filters">
                <div class="dropdown" id="teamDropdown">
                    <button class="dropdown-button" id="teamDropdownBtn">Select Teams</button>
                    <div class="dropdown-menu" id="teamDropdownMenu"></div>
                </div>

                <div class="dropdown" id="monthDropdown">
                    <button class="dropdown-button" id="monthDropdownBtn">Select Months</button>
                    <div class="dropdown-menu" id="monthDropdownMenu"></div>
                </div>
            </div>

            <!-- right: download -->
            <div class="download-area">
                <button id="downloadBtn" class="download-button" title="Download schedule as image">Download</button>
            </div>
        </div>

        <!-- Spinner overlay - appears above modal -->
        <div id="spinnerOverlay" class="spinner-overlay">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p>Generating <span id="spinnerProgress">0</span> of <span id="spinnerTotal">0</span> calendars...</p>
            </div>
        </div>

        <!-- Download confirmation modal -->
        <div id="downloadModal" class="modal" aria-hidden="true">
            <div id="downloadBackdrop" class="modal-backdrop" tabindex="-1"></div>
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="downloadModalTitle">
                <div class="modal-header">
                    <h3 id="downloadModalTitle">Confirm Download</h3>
                    <button id="modalCloseBtn" class="modal-close" aria-label="Close modal">×</button>
                </div>
                
                <!-- Confirmation view -->
                <div class="modal-confirm" id="modalConfirm">
                    <div class="modal-body">
                        <div><strong>Teams:</strong> <span id="modalTeams"></span></div>
                        <div style="margin-top:0.5rem"><strong>Months:</strong> <span id="modalMonths"></span></div>
                    </div>
                    <div class="modal-actions">
                        <button id="cancelDownloadBtn" class="nav-button">Cancel</button>
                        <button id="confirmDownloadBtn" class="download-button">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <table class="calendar" id="calendar"></table>

    </div>

    <script>
        // Teams and their initial states (January 1, 2026)
        const teams = ['SITI', 'IRA', 'EKIN', 'BALQIS'];
        
        // Shift types
        const shifts = ['0800-1600', '0000-0800', '1600-0000'];
        
        // Friendly names for shifts
        const shiftNames = {
            '0000-0800': 'Night',
            '0800-1600': 'Morning',
            '1600-0000': 'Evening'
        };
        
        // Current month/year (declare before using in selectedMonths)
        let currentMonth = 0; // January 2026
        let currentYear = 2026;
        
        // Selected filters (default: all teams, all months)
        let selectedTeams = [...teams];
        let selectedMonths = Array.from({ length: 12 }, (_, i) => i); // select all months by default

        // Initial state for January 1, 2026
        const initialState = {
            'SITI': { shift: '1600-0000', dayInCycle: 5 },
            'IRA': { shift: 'off', dayInCycle: 7 },
            'EKIN': { shift: '0800-1600', dayInCycle: 3 },
            'BALQIS': { shift: '0000-0800', dayInCycle: 1 }
        };
        
        // Calculate schedule for a specific date
        function getScheduleForDate(date) {
            const jan1_2026 = new Date(2026, 0, 1);
            const daysDiff = Math.floor((date - jan1_2026) / (1000 * 60 * 60 * 24));
            
            const schedule = {};
            
            for (const team of teams) {
                const initial = initialState[team];
                let dayInCycle = initial.dayInCycle + daysDiff;
                
                // Handle the 8-day cycle (6 work days + 2 off days)
                dayInCycle = ((dayInCycle - 1) % 8) + 1;
                
                if (dayInCycle === 7) {
                    schedule[team] = { shift: 'off', dayInCycle: 7 };
                } else if (dayInCycle === 8) {
                    schedule[team] = { shift: 'rest', dayInCycle: 8 };
                } else {
                    // Determine which shift based on rotation
                    let currentShift;
                    
                    // For each team, calculate their shift based on rotation
                    if (team === 'SITI') {
                        const workCyclesPassed = Math.floor((daysDiff + initial.dayInCycle - 1) / 8);
                        const shiftIndex = (2 + workCyclesPassed) % 3; // Starts at index 2 (1600-0000)
                        currentShift = shifts[shiftIndex];
                    } else if (team === 'IRA') {
                        const adjustedDays = daysDiff - 2; // Jan 3 is day 0 for IRA's first work cycle
                        if (adjustedDays < 0) {
                            if (dayInCycle === 7) currentShift = 'off';
                            else if (dayInCycle === 8) currentShift = 'rest';
                        } else {
                            const workCyclesPassed = Math.floor((adjustedDays) / 8);
                            const shiftIndex = (2 + workCyclesPassed) % 3; // Starts at index 2 (1600-0000)
                            currentShift = shifts[shiftIndex];
                        }
                    } else if (team === 'EKIN') {
                        const workCyclesPassed = Math.floor((daysDiff + initial.dayInCycle - 1) / 8);
                        const shiftIndex = (0 + workCyclesPassed) % 3; // Starts at index 0 (0800-1600)
                        currentShift = shifts[shiftIndex];
                    } else if (team === 'BALQIS') {
                        const workCyclesPassed = Math.floor((daysDiff + initial.dayInCycle - 1) / 8);
                        const shiftIndex = (1 + workCyclesPassed) % 3; // Starts at index 1 (0000-0800)
                        currentShift = shifts[shiftIndex];
                    }
                    
                    schedule[team] = { shift: currentShift, dayInCycle: dayInCycle };
                }
            }
            
            return schedule;
        }

        // update CSS var for header height so weekday header sticks correctly
        function updateHeaderHeight() {
            const hdr = document.querySelector('.header');
            const h = hdr ? Math.ceil(hdr.getBoundingClientRect().height) : 0;
            document.documentElement.style.setProperty('--header-height', `${h}px`);
        }
        // call on resize/initial
        window.addEventListener('resize', updateHeaderHeight);
        window.addEventListener('load', updateHeaderHeight);

        // Generate calendar for the current month
        function getVisibleMonths() {
             const months = selectedMonths.length ? selectedMonths.slice() : Array.from({ length: 12 }, (_, i) => i);
             months.sort((a, b) => a - b);
             return months;
         }
         function generateCalendar(root = document) {
             const calendar = root.querySelector('#calendar');
             const monthYear = root.querySelector('#monthYear');
             const prevBtn = root.querySelector('#prevBtn');
             const nextBtn = root.querySelector('#nextBtn');
             
            // treat empty selection as "select all" for rendering
             const teamsToShow = selectedTeams.length ? selectedTeams : [...teams];
             const monthsToShow = getVisibleMonths();

            // if no months selected, show nothing and disable nav
            if (monthsToShow.length === 0) {
                calendar.innerHTML = '';
                monthYear.textContent = 'No month selected';
                prevBtn.textContent = '';
                nextBtn.textContent = '';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }

            // ensure currentMonth is within visible months
            if (!monthsToShow.includes(currentMonth)) currentMonth = monthsToShow[0];
             
             const date = new Date(currentYear, currentMonth, 1);
             const monthName = date.toLocaleString('en-US', { month: 'long' });
             monthYear.textContent = `${monthName} ${currentYear}`;
             
             // Helper to get month name for given year/month
             function getMonthName(y, m) {
                 return new Date(y, m, 1).toLocaleString('en-US', { month: 'long' });
             }
 

            // Determine labels for prev/next buttons (looping within selected months)
            const idx = monthsToShow.indexOf(currentMonth);
            const prevIndex = (idx - 1 + monthsToShow.length) % monthsToShow.length;
            const nextIndex = (idx + 1) % monthsToShow.length;
            prevBtn.textContent = getMonthName(currentYear, monthsToShow[prevIndex]);
            nextBtn.textContent = getMonthName(currentYear, monthsToShow[nextIndex]);
            prevBtn.disabled = monthsToShow.length <= 1;
            nextBtn.disabled = monthsToShow.length <= 1;
 
             // Build table with thead/tbody so weekday header can be sticky
             calendar.innerHTML = '';
             const thead = document.createElement('thead');
             const headerRow = document.createElement('tr');
             const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
             for (const day of daysOfWeek) {
                 const th = document.createElement('th');
                 th.textContent = day;
                 headerRow.appendChild(th);
             }
             thead.appendChild(headerRow);
             calendar.appendChild(thead);

             const firstDay = new Date(currentYear, currentMonth, 1).getDay();
             const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
             const tbody = document.createElement('tbody');

             let dayCount = 1;
             let rowCount = Math.ceil((firstDay + daysInMonth) / 7);
             for (let i = 0; i < rowCount; i++) {
                 const row = document.createElement('tr');
                 for (let j = 0; j < 7; j++) {
                     const cell = document.createElement('td');
                     if (i === 0 && j < firstDay) {
                         cell.classList.add('empty-day');
                     } else if (dayCount > daysInMonth) {
                         cell.classList.add('empty-day');
                     } else {
                         const currentDate = new Date(currentYear, currentMonth, dayCount);
                         const schedule = getScheduleForDate(currentDate);
                         const dayNumber = document.createElement('div');
                         dayNumber.className = 'day-number';
                         dayNumber.textContent = dayCount;
                         cell.appendChild(dayNumber);

                        for (const team of teamsToShow) {
                            const teamDiv = document.createElement('div');
                            teamDiv.className = 'team-schedule';
                            const shift = schedule[team].shift;
                            teamDiv.classList.add(`shift-${shift.replace(':', '')}`);
                            const teamName = document.createElement('span');
                            teamName.className = 'team-name';
                            teamName.textContent = team;
                            teamDiv.appendChild(teamName);
                            const shiftTime = document.createElement('span');
                            shiftTime.className = 'shift-time';
                            shiftTime.textContent = shift === 'off'
                                ? 'Off Day'
                                : shift === 'rest'
                                ? 'Rest Day'
                                : (shiftNames[shift] || shift);
                            teamDiv.appendChild(shiftTime);
                            const dayInCycle = schedule[team].dayInCycle;
                            if (shift !== 'off' && shift !== 'rest') {
                                const kerjaInfo = document.createElement('span');
                                kerjaInfo.className = 'shift-time';
                                kerjaInfo.textContent = `Day ${dayInCycle}`;
                                teamDiv.appendChild(kerjaInfo);
                            }
                            cell.appendChild(teamDiv);
                        }
                        dayCount++;
                     }
                     row.appendChild(cell);
                 }
                 tbody.appendChild(row);
             }
             calendar.appendChild(tbody);

            // update header height after DOM changes (weekday sticky top depends on it)
            setTimeout(updateHeaderHeight, 0);
            
             // Buttons always enabled (months loop)
             prevBtn.disabled = false;
             nextBtn.disabled = false;
         }
 
        // Change month (move within visible/selected months)
        function changeMonth(direction) {
            const months = getVisibleMonths();
            if (months.length === 0) return;
            let idx = months.indexOf(currentMonth);
            if (idx === -1) {
                currentMonth = months[0];
                generateCalendar();
                return;
            }
            const newIdx = (idx + direction + months.length) % months.length;
            currentMonth = months[newIdx];
            generateCalendar();
        }

        function populateFilters() {
            const teamMenu = document.getElementById('teamDropdownMenu');
            const monthMenu = document.getElementById('monthDropdownMenu');
            const teamBtn = document.getElementById('teamDropdownBtn');
            const monthBtn = document.getElementById('monthDropdownBtn');

            // Populate teams menu
            teamMenu.innerHTML = '';

            // "Select All" for teams (toggle: select all / clear all)
            const teamAll = document.createElement('div');
            teamAll.className = 'dropdown-item' + (selectedTeams.length === teams.length ? ' selected' : '');
            teamAll.dataset.value = '__select_all_teams';
            teamAll.innerHTML = `<span class="tick">✓</span><span>Select All</span>`;
            teamAll.addEventListener('click', (e) => {
                e.stopPropagation();
                if (selectedTeams.length === teams.length) {
                    // currently all selected -> clear selection
                    selectedTeams = [];
                } else {
                    // select all
                    selectedTeams = [...teams];
                }
                // do NOT auto-convert empty -> all; allow empty selection
                populateFilters();
                generateCalendar();
            });
            teamMenu.appendChild(teamAll);

            for (const t of teams) {
                const item = document.createElement('div');
                item.className = 'dropdown-item' + (selectedTeams.includes(t) ? ' selected' : '');
                item.dataset.value = t;
                item.innerHTML = `<span class="tick">✓</span><span>${t}</span>`;
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = selectedTeams.indexOf(t);
                    if (idx === -1) selectedTeams.push(t);
                    else selectedTeams.splice(idx, 1);
                    // allow empty selection (do not force select-all)
                    populateFilters(); // refresh UI
                    generateCalendar();
                });
                teamMenu.appendChild(item);
            }

            // Populate months menu
            monthMenu.innerHTML = '';

            // "Select All" for months (toggle: select all / clear all)
            const monthsAll = document.createElement('div');
            monthsAll.className = 'dropdown-item' + (selectedMonths.length === 12 ? ' selected' : '');
            monthsAll.dataset.value = '__select_all_months';
            monthsAll.innerHTML = `<span class="tick">✓</span><span>Select All</span>`;
            monthsAll.addEventListener('click', (e) => {
                e.stopPropagation();
                if (selectedMonths.length === 12) {
                    // clear all months
                    selectedMonths = [];
                } else {
                    // select all months
                    selectedMonths = Array.from({length:12}, (_,i) => i);
                }
                // update visible month only if there is at least one selected
                if (selectedMonths.length > 0) currentMonth = selectedMonths[0];
                populateFilters();
                generateCalendar();
            });
            monthMenu.appendChild(monthsAll);

            for (let m = 0; m < 12; m++) {
                const name = new Date(2026, m, 1).toLocaleString('en-US', { month: 'long' });
                const item = document.createElement('div');
                const selected = selectedMonths.includes(m);
                item.className = 'dropdown-item' + (selected ? ' selected' : '');
                item.dataset.value = String(m);
                item.innerHTML = `<span class="tick">✓</span><span>${name}</span>`;
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const i = selectedMonths.indexOf(m);
                    if (i === -1) selectedMonths.push(m);
                    else selectedMonths.splice(i, 1);
                    // if no months selected, leave selectedMonths empty (do not force select-all)
                    if (selectedMonths.length > 0) {
                        currentMonth = selectedMonths[0];
                    }
                    populateFilters();
                    generateCalendar();
                });
                monthMenu.appendChild(item);
            }
            
            // Keep clicks inside menus from closing dropdown (close only on outside click)
            teamMenu.addEventListener('click', e => e.stopPropagation());
            monthMenu.addEventListener('click', e => e.stopPropagation());

            // Button open/close handlers
            const teamDropdown = document.getElementById('teamDropdown');
            const monthDropdown = document.getElementById('monthDropdown');
            teamBtn.onclick = (e) => {
                e.stopPropagation();
                const opened = teamDropdown.classList.toggle('open');
                if (opened) monthDropdown.classList.remove('open');
                // header height might change (dropdown expands) -> update
                setTimeout(updateHeaderHeight, 0);
            };
            monthBtn.onclick = (e) => {
                e.stopPropagation();
                const opened = monthDropdown.classList.toggle('open');
                if (opened) teamDropdown.classList.remove('open');
                setTimeout(updateHeaderHeight, 0);
            };
        }

        // close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            setTimeout(updateHeaderHeight, 0);
        });

        // Initialize filters + calendar
        populateFilters();
        generateCalendar();
        // initial header height calc
        setTimeout(updateHeaderHeight, 0);

        // --- Custom Calendar Image Generation ---
        async function drawCalendarToCanvas(month, year, teamsToShow) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Scale factor for high quality export
            const scale = 4;
            
            // Colors
            const colors = {
                background: '#ffffff',
                header: '#667eea',
                headerText: '#ffffff',
                gridLine: '#dddddd',
                dayNumber: '#333333',
                '0000-0800': { bg: '#4a5568', text: '#ffffff' },
                '0800-1600': { bg: '#48bb78', text: '#ffffff' },
                '1600-0000': { bg: '#ed8936', text: '#ffffff' },
                'off': { bg: '#e2e8f0', text: '#4a5568' },
                'rest': { bg: '#e2e8f0', text: '#4a5568' }
            };
            
            // Calculate minimum column width based on content (base size)
            ctx.font = 'bold 32px Arial';
            let maxTextWidth = 0;
            
            // Check team names
            teamsToShow.forEach(team => {
                const width = ctx.measureText(team).width;
                if (width > maxTextWidth) maxTextWidth = width;
            });
            
            // Check shift names
            ctx.font = '24px Arial';
            Object.values(shiftNames).forEach(shift => {
                const width = ctx.measureText(shift).width;
                if (width > maxTextWidth) maxTextWidth = width;
            });
            const offWidth = ctx.measureText('Off Day').width;
            const restWidth = ctx.measureText('Rest Day').width;
            if (offWidth > maxTextWidth) maxTextWidth = offWidth;
            if (restWidth > maxTextWidth) maxTextWidth = restWidth;
            
            // Base dimensions
            const baseCellWidth = Math.max(maxTextWidth + 80, 200);
            const baseWidth = baseCellWidth * 7;
            const baseHeight = 1800;
            
            // Apply scale for high resolution
            const cellWidth = baseCellWidth * scale;
            const width = baseWidth * scale;
            const height = baseHeight * scale;
            
            canvas.width = width;
            canvas.height = height;
            
            // Scale context for all operations
            ctx.scale(scale, scale);
            
            // Fill background
            ctx.fillStyle = colors.background;
            ctx.fillRect(0, 0, baseWidth, baseHeight);
            
            // Draw title
            const monthName = new Date(year, month, 1).toLocaleString('en-US', { month: 'long' });
            ctx.fillStyle = colors.header;
            ctx.fillRect(0, 0, baseWidth, 100);
            ctx.fillStyle = colors.headerText;
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${monthName} ${year}`, baseWidth / 2, 50);
            
            // Draw weekday headers
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const headerY = 100;
            const headerHeight = 60;
            
            ctx.fillStyle = colors.header;
            ctx.fillRect(0, headerY, baseWidth, headerHeight);
            ctx.fillStyle = colors.headerText;
            ctx.font = 'bold 28px Arial';
            
            for (let i = 0; i < 7; i++) {
                ctx.fillText(daysOfWeek[i], baseCellWidth * i + baseCellWidth / 2, headerY + headerHeight / 2);
            }
            
            // Calculate calendar layout
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const rowCount = Math.ceil((firstDay + daysInMonth) / 7);
            const cellHeight = (baseHeight - headerY - headerHeight) / rowCount;
            
            // Draw grid and days
            let dayCount = 1;
            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < 7; col++) {
                    const x = col * baseCellWidth;
                    const y = headerY + headerHeight + row * cellHeight;
                    
                    // Draw cell border
                    ctx.strokeStyle = colors.gridLine;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, baseCellWidth, cellHeight);
                    
                    // Draw day content
                    if (row === 0 && col < firstDay) {
                        // Empty cell before month starts
                        continue;
                    } else if (dayCount > daysInMonth) {
                        // Empty cell after month ends
                        continue;
                    } else {
                        const currentDate = new Date(year, month, dayCount);
                        const schedule = getScheduleForDate(currentDate);
                        
                        // Draw day number
                        ctx.fillStyle = colors.dayNumber;
                        ctx.font = 'bold 44px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(dayCount, x + baseCellWidth / 2, y + 50);
                        
                        // Draw team schedules
                        const teamHeight = (cellHeight - 70) / teamsToShow.length;
                        teamsToShow.forEach((team, idx) => {
                            const teamY = y + 70 + idx * teamHeight;
                            const shift = schedule[team].shift;
                            const color = colors[shift] || colors['off'];
                            
                            // Draw team background
                            ctx.fillStyle = color.bg;
                            ctx.fillRect(x + 10, teamY + 5, baseCellWidth - 20, teamHeight - 10);
                            
                            // Draw team name
                            ctx.fillStyle = color.text;
                            ctx.font = 'bold 32px Arial';
                            ctx.textAlign = 'left';
                            ctx.fillText(team, x + 20, teamY + teamHeight / 3);
                            
                            // Draw shift info
                            ctx.font = '24px Arial';
                            const shiftText = shift === 'off' ? 'Off Day' :
                                            shift === 'rest' ? 'Rest Day' :
                                            shiftNames[shift] || shift;
                            ctx.fillText(shiftText, x + 20, teamY + teamHeight / 3 + 35);
                            
                            // Draw day in cycle
                            if (shift !== 'off' && shift !== 'rest') {
                                ctx.fillText(`Day ${schedule[team].dayInCycle}`, x + 20, teamY + teamHeight / 3 + 65);
                            }
                        });
                        
                        dayCount++;
                    }
                }
            }
            
            return canvas;
        }

        async function downloadScheduleImagesForSelectedMonths() {
            const monthsToDownload = getVisibleMonths();
            if (monthsToDownload.length === 0) {
                alert('No months selected to download.');
                return;
            }
            
            const teamsToShow = selectedTeams.length ? selectedTeams : [...teams];
            
            // Show spinner overlay
            const spinnerOverlay = document.getElementById('spinnerOverlay');
            spinnerOverlay.classList.add('active');
            document.getElementById('spinnerTotal').textContent = monthsToDownload.length;
            
            // Disable close button during download
            document.getElementById('modalCloseBtn').disabled = true;
            
            for (let i = 0; i < monthsToDownload.length; i++) {
                const m = monthsToDownload[i];
                
                // Update progress
                document.getElementById('spinnerProgress').textContent = i + 1;
                
                try {
                    const canvas = await drawCalendarToCanvas(m, currentYear, teamsToShow);
                    
                    await new Promise((resolve) => {
                        canvas.toBlob((blob) => {
                            if (!blob) {
                                console.warn('Export failed for month', m);
                                resolve();
                                return;
                            }
                            const a = document.createElement('a');
                            const monthLabel = getMonthNameForFile(m, currentYear);
                            a.href = URL.createObjectURL(blob);
                            a.download = `${getTeamsFilenameSegment()}_${monthLabel}_${currentYear}.png`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            setTimeout(() => URL.revokeObjectURL(a.href), 10000);
                            resolve();
                        }, 'image/png', 1);
                     });
                  } catch (err) {
                     console.error('Export failed for month', m, err);
                  }
            }
            
            // Hide spinner overlay
            spinnerOverlay.classList.remove('active');
            
            // Re-enable close button after download completes
            document.getElementById('modalCloseBtn').disabled = false;
            
            // Auto-close modal after all downloads complete
            closeDownloadModal();
        }

        // Replace the download functions with custom canvas drawing:

        // Show confirmation modal before starting downloads
        function formatTeamsForModal() {
            return (selectedTeams.length ? selectedTeams : teams).join(', ');
        }
        function formatMonthsForModal() {
            const months = selectedMonths.length ? selectedMonths : Array.from({length:12}, (_,i) => i);
            return months.map(m => new Date(2026, m, 1).toLocaleString('en-US', { month: 'long' })).join(', ');
        }

       // filename helpers: TeamA-TeamB_Month_Year
       function getTeamsFilenameSegment() {
           const list = selectedTeams.length ? selectedTeams : teams;
           return list.join('-');
       }
       function getMonthNameForFile(m, y) {
           return new Date(y, m, 1).toLocaleString('en-US', { month: 'long' }).replace(/\s+/g, '_');
       }

        function showDownloadModal(e) {
            e?.stopPropagation();
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            setTimeout(updateHeaderHeight, 0);
            document.getElementById('modalTeams').textContent = formatTeamsForModal();
            document.getElementById('modalMonths').textContent = formatMonthsForModal();
            
            // Reset modal to confirmation view
            document.getElementById('modalCloseBtn').disabled = false;
            
            const modal = document.getElementById('downloadModal');
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDownloadModal() {
            const modal = document.getElementById('downloadModal');
            modal.classList.remove('open');
            document.body.style.overflow = '';
        }

        document.getElementById('downloadBtn').addEventListener('click', showDownloadModal);
        document.getElementById('cancelDownloadBtn').addEventListener('click', closeDownloadModal);
        document.getElementById('modalCloseBtn').addEventListener('click', closeDownloadModal);
        document.getElementById('downloadBackdrop').addEventListener('click', (e) => {
            // Backdrop click disabled - only X button can close
        });
        document.getElementById('confirmDownloadBtn').addEventListener('click', async () => {
            await downloadScheduleImagesForSelectedMonths();
        });
     </script>
 </body>
</html>