<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SHIFT SCHEDULE 2026</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'/%3E%3Cline x1='16' y1='2' x2='16' y2='6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10'/%3E%3C/svg%3E" />
<style>
  /* ============================================
     GLOBAL STYLES
     ============================================ */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: Tahoma, sans-serif;
    background-color: #ffffff;
    color: #111827;
    overflow-y: scroll;
  }

  .container {
    display: flex;
    flex-direction: column;
    padding: 0 1.5rem 1.5rem 1.5rem;
    min-width: fit-content;
    background: #10B981;
  }

  /* ============================================
     HEADER SECTION (TOP)
     ============================================ */
  header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    position: sticky;
    top: 0;
    background-color: orange;
    z-index: 100;
    border-bottom: 2px solid #e5e7eb;
    padding-top: 1.5rem
  }

  /* Month Navigation */
  .month-nav {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    overflow-y: visible;
    background-color: #ff34e0;
  }
  
  .month-nav-left {
    display: flex;
    align-items: center;
    gap: 1rem;
    justify-content: center;
    width: 100%;
  }
  
  .nav-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 9999px;
    background: #f3f4f6;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    border: none;
    cursor: pointer;
  }

  .nav-button:hover {
    background: #e5e7eb;
  }

  .month-title {
    font-size: 2.25rem;
    font-weight: 700;
    color: #111827;
  }

  /* Filters Row (Team, Month, Download) */
  .filters {
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    width: 100%;
    background-color: #fce48c;
  }

  /* Dropdown Component */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown__button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    background: #f3f4f6;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    border: none;
  }

  .dropdown__button:hover {
    background: #e5e7eb;
  }

  .dropdown__label {
    flex: 1;
    text-align: left;
    white-space: nowrap;
  }

  .dropdown__list {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    z-index: 1000;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
  }

  .dropdown__item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
  }

  .dropdown__item:hover {
    background: #f9fafb;
  }

  .dropdown__item-tick {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid #d1d5db;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: transparent;
    font-size: 0.75rem;
  }

  .dropdown__item--checked .dropdown__item-tick {
    background: #10B981;
    color: #fff;
    border-color: #10B981;
  }

  /* Download Button */
  .download-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 9999px;
    background: #ef4444;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: white;
    border: none;
    cursor: pointer;
  }

  .download-button:hover {
    background: #dc2626;
  }

  .download-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ============================================
     MAIN CALENDAR SECTION
     ============================================ */
  main {
    flex-grow: 1;
  }

  /* Weekday Headers */
  .weekday-headers {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
    border-top: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: var(--header-height);
    background-color: #e3f2fd;
    z-index: 50;
  }

  .weekday-header {
    padding: 0.75rem;
    text-align: center;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    border-right: 1px solid #e5e7eb;
    background-color: #bbdefb;
  }

  .weekday-header:last-child {
    border-right: none;
  }

  /* Calendar Grid */
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
  }

  .calendar-day {
    display: flex;
    flex-direction: column;
    min-height: 120px;
    padding: 0.75rem;
    padding-top: 0.5rem;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f1f8e9;
  }

  .calendar-day:nth-child(7n) {
    border-right: none;
  }

  .day-number {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .weekend {
    color: #9ca3af;
  }

  /* Shift Items */
  .shift-item {
    margin-top: 0.25rem;
    border-radius: 0.5rem;
    padding: 0.25rem 0.5rem;
  }

  .shift-person {
    font-size: 0.75rem;
    font-weight: 600;
    color: #1f2937;
  }

  .shift-type {
    font-size: 0.75rem;
    color: #374151;
  }

  .shift-day {
    font-size: 0.75rem;
    color: #4b5563;
  }

  /* Shift Colors */
  .shift-morning {
    background: linear-gradient(90deg, #ECFDF5, rgba(255,255,255,0));
    border-left: 4px solid #10B981;
  }
  
  .shift-night {
    background: linear-gradient(90deg, #EEF2FF, rgba(255,255,255,0));
    border-left: 4px solid #4F46E5;
  }
  
  .shift-afternoon {
    background: linear-gradient(90deg, #FFF1F2, rgba(255,255,255,0));
    border-left: 4px solid #EC4899;
  }
  
  .shift-off {
    background: #F3F4F6;
    border-left: 4px solid #9CA3AF;
  }
  
  .shift-rest {
    background: #F3F4F6;
    border-left: 4px solid #9CA3AF;
  }

  /* ============================================
     MODAL (DOWNLOAD MODAL)
     ============================================ */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal__content {
    position: relative;
    background: #ffffff;
    border-radius: 1.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal__title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
  }

  .modal__close {
    padding: 0.5rem;
    border-radius: 9999px;
    background: transparent;
    border: none;
    cursor: pointer;
  }

  .modal__close:hover {
    background: #f3f4f6;
  }

  .modal__body {
    padding: 1.5rem;
  }

  .modal__info {
    background: #f9fafb;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1.25rem;
  }

  .modal__info-row {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .modal__info-row:last-child {
    margin-bottom: 0;
  }

  .modal__info-label {
    font-weight: 600;
    color: #374151;
    min-width: 60px;
  }

  .modal__info-value {
    color: #111827;
    flex: 1;
  }

  .modal__message {
    font-size: 1rem;
    color: #374151;
    line-height: 1.5;
  }

  .modal__loading {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
  }

  .modal__loading.visible {
    display: flex;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #f3f4f6;
    border-top-color: #10B981;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .modal__loading-text {
    font-size: 1rem;
    color: #374151;
    font-weight: 600;
  }

  .modal__progress {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .modal__footer {
    display: flex;
    gap: 0.75rem;
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }

  .modal__button {
    flex: 1;
    padding: 0.625rem 1.25rem;
    border-radius: 9999px;
    font-weight: 600;
    border: none;
    cursor: pointer;
  }

  .modal__button--cancel {
    background: #ffffff;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .modal__button--cancel:hover {
    background: #f9fafb;
  }

  .modal__button--confirm {
    background: #ef4444;
    color: white;
  }

  .modal__button--confirm:hover {
    background: #dc2626;
  }

  /* ============================================
     UTILITY CLASSES
     ============================================ */
  .u-visually-hidden {
    position: absolute !important;
    height: 1px;
    width: 1px;
    overflow: hidden;
    clip: rect(1px, 1px, 1px, 1px);
    white-space: nowrap;
    border: 0;
    padding: 0;
    margin: -1px;
  }

  .icon-svg {
    width: 24px;
    height: 24px;
    display: inline-block;
    vertical-align: middle;
    stroke: currentColor;
    fill: none;
  }

  .material-icons-outlined {
    font-size: 24px;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="month-nav">
      <div class="month-nav-left">
        <button id="prevMonth" class="nav-button" aria-label="Previous month">
          <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true"><polyline points="15 18 9 12 15 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        
        <h1 id="currentMonthDisplay" class="month-title">January</h1>
        
        <button id="nextMonth" class="nav-button" aria-label="Next month">
          <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true"><polyline points="9 6 15 12 9 18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="filters">
        <select id="teamSelect" aria-label="Select team" multiple size="4" class="u-visually-hidden">
          <option value="SITI">SITI</option>
          <option value="EKIN">EKIN</option>
          <option value="IRA">IRA</option>
          <option value="BALQIS">BALQIS</option>
        </select>
        <div id="teamDropdown" class="dropdown" aria-haspopup="listbox"></div>

        <select id="monthSelect" multiple size="6" aria-label="Select month(s)" class="u-visually-hidden"></select>
        <div id="monthDropdown" class="dropdown" aria-haspopup="listbox"></div>

        <button id="downloadBtn" class="download-button">
          <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="7 10 12 15 17 10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="15" x2="12" y2="3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>DOWNLOAD</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div class="weekday-headers">
      <div class="weekday-header">SUN</div>
      <div class="weekday-header">MON</div>
      <div class="weekday-header">TUE</div>
      <div class="weekday-header">WED</div>
      <div class="weekday-header">THU</div>
      <div class="weekday-header">FRI</div>
      <div class="weekday-header">SAT</div>
    </div>
    <div id="calendarContainer" class="calendar-grid"></div>
  </main>
</div>

<div id="downloadModal" class="modal" style="display: none;">
  <div class="modal__overlay"></div>
  <div class="modal__content">
    <div class="modal__header">
      <h2 class="modal__title">Download Schedule</h2>
      <button id="modalClose" class="modal__close" aria-label="Close modal">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="6" y1="6" x2="18" y2="18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
    <div id="modalBodyContent" class="modal__body">
      <div class="modal__info">
        <div class="modal__info-row">
          <span class="modal__info-label">Team:</span>
          <span id="modalTeamValue" class="modal__info-value"></span>
        </div>
        <div class="modal__info-row">
          <span class="modal__info-label">Month:</span>
          <span id="modalMonthValue" class="modal__info-value"></span>
        </div>
      </div>
      <div id="modalMessage" class="modal__message">
        Are you sure you want to download this schedule?
      </div>
    </div>
    <div id="modalLoading" class="modal__loading">
      <div class="spinner"></div>
      <div class="modal__loading-text">Downloading...</div>
      <div id="modalProgress" class="modal__progress">Processing image 1 of 1</div>
    </div>
    <div id="modalFooter" class="modal__footer">
      <button id="modalCancel" class="modal__button modal__button--cancel">
        CANCEL
      </button>
      <button id="modalConfirm" class="modal__button modal__button--confirm">
        DOWNLOAD
      </button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  /* ============================================
     HEADER: STICKY POSITION CALCULATION
     ============================================ */
  function updateWeekdayHeadersPosition() {
    const header = document.querySelector('header');
    if (header) {
      const headerHeight = header.offsetHeight;
      document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
    }
  }

  window.addEventListener('load', updateWeekdayHeadersPosition);
  window.addEventListener('resize', updateWeekdayHeadersPosition);

  /* ============================================
     SCHEDULE DATA: GENERATION & MANAGEMENT
     ============================================ */
  function fmtDate(d){
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  }

  function monthName(i){
    return ["January","February","March","April","May","June","July","August","September","October","November","December"][i];
  }

  const TEAM = ["SITI","EKIN","IRA","BALQIS"];
  const SHIFTS = ["MORNING","NIGHT","AFTERNOON"];
  function nextShift(s){ return SHIFTS[(SHIFTS.indexOf(s)+1) % SHIFTS.length]; }
  
  let statesOnStart = {
    "SITI":   { mode: "work", shift: "AFTERNOON", day: 5 },
    "EKIN":   { mode: "work", shift: "MORNING", day: 3 },
    "IRA":    { mode: "off", off_day: 1, next_shift: "AFTERNOON" },
    "BALQIS": { mode: "work", shift: "NIGHT", day: 1 }
  };

  function buildSchedule(startStr, endStr, initialStates){
    const start = new Date(startStr + "T00:00:00");
    const end = new Date(endStr + "T00:00:00");
    let d = new Date(start);
    let states = JSON.parse(JSON.stringify(initialStates));
    const schedule = {};
    while (d <= end){
      const key = fmtDate(d);
      schedule[key] = {};
      for (const person of TEAM){
        const st = states[person];
        if (st.mode === "work"){
          schedule[key][person] = `${st.shift} (day ${st.day})`;
        } else {
          schedule[key][person] = (st.off_day === 1) ? "OFF DAY" : "REST DAY";
        }
      }
      const newStates = {};
      for (const person of TEAM){
        const st = states[person];
        if (st.mode === "work"){
          const nd = st.day + 1;
          if (nd <= 6){
            newStates[person] = { mode: "work", shift: st.shift, day: nd };
          } else {
            newStates[person] = { mode: "off", off_day: 1, next_shift: nextShift(st.shift) };
          }
        } else {
          const offn = st.off_day + 1;
          if (offn <= 2){
            newStates[person] = { mode: "off", off_day: offn, next_shift: st.next_shift };
          } else {
            newStates[person] = { mode: "work", shift: st.next_shift, day: 1 };
          }
        }
      }
      states = newStates;
      d.setDate(d.getDate() + 1);
    }
    return schedule;
  }

  const scheduleMap = buildSchedule("2026-01-01", "2026-12-31", statesOnStart);

  /* ============================================
     INITIALIZATION: VARIABLES & CONSTANTS
     ============================================ */
  const monthSelect = document.getElementById('monthSelect');
  const container = document.getElementById('calendarContainer');
  const teamSelect = document.getElementById('teamSelect');

  const MIN_YEAR = 2026, MAX_YEAR = 2026, MIN_MONTH = 0, MAX_MONTH = 11;
  
  function clampToRange(year, month){
    if (year < MIN_YEAR) return { year: MIN_YEAR, month: MIN_MONTH };
    if (year > MAX_YEAR) return { year: MAX_YEAR, month: MAX_MONTH };
    if (month < MIN_MONTH) month = MIN_MONTH;
    if (month > MAX_MONTH) month = MAX_MONTH;
    return { year, month };
  }
  
  const now = new Date();
  let { year: currentYear, month: currentMonth } = clampToRange(now.getFullYear(), now.getMonth());
  let displayedIndex = 0;

  /* ============================================
     HEADER: MONTH DISPLAY UPDATE
     ============================================ */
  function updateMonthDisplay() {
    const displayElement = document.getElementById('currentMonthDisplay');
    if (displayElement) {
      displayElement.textContent = monthName(currentMonth);
    }
  }

  updateMonthDisplay();

  /* ============================================
     HEADER: SELECT POPULATION
     ============================================ */
  function populateMonthSelect(){
    monthSelect.innerHTML = "";
    for (let m=0;m<12;m++){
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = monthName(m).slice(0,3).toUpperCase();
      opt.selected = true;
      monthSelect.appendChild(opt);
    }
  }
  populateMonthSelect();

  function selectAllTeamOptions(){
    for (const opt of teamSelect.options){
      opt.selected = true;
    }
  }
  selectAllTeamOptions();

  /* ============================================
     HEADER: FILTER FUNCTIONS
     ============================================ */
  function getSelectedTeams(){
    const sel = Array.from(teamSelect.selectedOptions).map(o=>o.value);
    if (sel.length === 0) return TEAM.slice();
    return sel;
  }

  function getSelectedMonths(){
    const sel = Array.from(monthSelect.selectedOptions).map(o=>Number(o.value));
    if (sel.length === 0) return [currentMonth];
    return sel.sort((a,b)=>a-b);
  }

  /* ============================================
     CALENDAR: RENDER FUNCTIONS
     ============================================ */
  function renderMonthGrid(year, month, selectedTeams){
    let html = '';
    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);
    const firstWeekday = first.getDay();
    const totalDays = last.getDate();

    for (let i=0;i<firstWeekday;i++){
      html += `<div class="calendar-day"></div>`;
    }

    for (let day=1; day<= totalDays; day++){
      const dt = new Date(year, month, day);
      const key = fmtDate(dt);
      const dayAssignments = scheduleMap[key];
      const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;
      
      let cell = `<div class="calendar-day ${isWeekend ? 'weekend' : ''}">`;
      cell += `<span class="day-number">${day}</span>`;
      
      for (const p of selectedTeams){
        const val = dayAssignments ? dayAssignments[p] : "";
        if (!val) continue;
        
        const v = val.toUpperCase();
        let shiftClass = "";
        if (v.startsWith("MORNING")) shiftClass = "shift-morning";
        else if (v.startsWith("NIGHT")) shiftClass = "shift-night";
        else if (v.startsWith("AFTERNOON")) shiftClass = "shift-afternoon";
        else if (v === "OFF DAY") shiftClass = "shift-off";
        else if (v === "REST DAY") shiftClass = "shift-rest";
        
        const dayMatch = val.match(/\(day\s*(\d+)\)/i);
        const mainLabel = val.replace(/\s*\(day\s*\d+\)\s*/i, '').trim();
        
        cell += `<div class="shift-item ${shiftClass}">`;
        cell += `<div class="shift-person">${p}</div>`;
        cell += `<div class="shift-type">${mainLabel}</div>`;
        if (dayMatch) {
          cell += `<div class="shift-day">Day ${dayMatch[1]}</div>`;
        }
        cell += `</div>`;
      }
      
      cell += `</div>`;
      html += cell;
    }

    const used = firstWeekday + totalDays;
    const trailing = (7 - (used % 7)) % 7;
    for (let i=0;i<trailing;i++){
      html += `<div class="calendar-day"></div>`;
    }

    return html;
  }

  function renderSelectedMonths(){
    const months = getSelectedMonths();
    const teams = getSelectedTeams();
    if (displayedIndex >= months.length) displayedIndex = Math.max(0, months.length - 1);
    if (displayedIndex < 0) displayedIndex = 0;

    const monthToShow = (months.length > 0) ? months[displayedIndex] : currentMonth;
    currentMonth = monthToShow;
    
    updateMonthDisplay();
    
    let out = renderMonthGrid(MIN_YEAR, monthToShow, teams);
    container.innerHTML = out;
  }

  /* ============================================
     HEADER: EVENT LISTENERS
     ============================================ */
  teamSelect.addEventListener('change', renderSelectedMonths);
  monthSelect.addEventListener('change', ()=>{
    displayedIndex = 0;
    renderSelectedMonths();
  });

  document.getElementById('prevMonth').addEventListener('click', ()=>{
    const months = getSelectedMonths();
    if (months.length === 0) return;
    displayedIndex = (displayedIndex - 1 + months.length) % months.length;
    renderSelectedMonths();
  });

  document.getElementById('nextMonth').addEventListener('click', ()=>{
    const months = getSelectedMonths();
    if (months.length === 0) return;
    displayedIndex = (displayedIndex + 1) % months.length;
    renderSelectedMonths();
  });

  /* ============================================
     HEADER: DROPDOWN COMPONENT
     ============================================ */
  function initMultiDrop(hiddenSelectId, dropdownId, placeholder, allLabel){
    const hidden = document.getElementById(hiddenSelectId);
    const wrap = document.getElementById(dropdownId);
  
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dropdown__button';
    btn.innerHTML = `<span class="dropdown__label">${placeholder}</span><svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true"><polyline points="6 9 12 15 18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    wrap.appendChild(btn);
  
    const list = document.createElement('div');
    list.className = 'dropdown__list';
    list.style.display = 'none';
    wrap.appendChild(list);
  
    function buildList(){
      list.innerHTML = '';
      const opts = Array.from(hidden.options);
      if (opts.length === 0){
        const e = document.createElement('div'); 
        e.style.cssText = 'padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #6b7280;'; 
        e.textContent = 'NO OPTIONS'; 
        list.appendChild(e);
        return;
      }

      const selectAllItem = document.createElement('div');
      selectAllItem.className = 'dropdown__item';
      const allSelected = opts.every(opt => opt.selected);
      if (allSelected) selectAllItem.classList.add('dropdown__item--checked');
      selectAllItem.innerHTML = `<span class="dropdown__item-tick">${allSelected ? '✓' : ''}</span><span style="font-weight: 600;">SELECT ALL</span>`;
      selectAllItem.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const shouldSelectAll = !opts.every(opt => opt.selected);
        opts.forEach(opt => {
          opt.selected = shouldSelectAll;
        });
        hidden.dispatchEvent(new Event('change', { bubbles: true }));
        buildList();
        refreshButton();
      });
      list.appendChild(selectAllItem);

      const separator = document.createElement('div');
      separator.style.cssText = 'height: 1px; background: #e5e7eb; margin: 4px 0;';
      list.appendChild(separator);

      for (const opt of opts){
        const it = document.createElement('div');
        it.className = 'dropdown__item';
        if (opt.selected) it.classList.add('dropdown__item--checked');
        it.setAttribute('data-value', opt.value);
        it.innerHTML = `<span class="dropdown__item-tick">${opt.selected ? '✓' : ''}</span><span>${opt.textContent.toString().toUpperCase()}</span>`;
        it.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          opt.selected = !opt.selected;
          if (opt.selected) it.classList.add('dropdown__item--checked'); 
          else it.classList.remove('dropdown__item--checked');
          it.querySelector('.dropdown__item-tick').textContent = opt.selected ? '✓' : '';
          hidden.dispatchEvent(new Event('change', { bubbles: true }));
          refreshButton();
          buildList();
        });
        list.appendChild(it);
      }
    }
  
    function refreshButton(){
      const labelEl = btn.querySelector('.dropdown__label');
      // always show default placeholder text, do not display specific selections
      labelEl.textContent = placeholder;
    }
  
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const visible = list.style.display === 'block';
      document.querySelectorAll('.dropdown__list').forEach(l=>l.style.display='none');

      if (!visible) {
        list.style.display = 'block';
      } else {
        list.style.display = 'none';
      }
    });
  
    document.addEventListener('click', (e)=> {
      if (!wrap.contains(e.target)) list.style.display = 'none';
    });
  
    hidden.addEventListener('change', ()=>{
      buildList();
      refreshButton();
    });
  
    buildList();
    refreshButton();
  }
  
  initMultiDrop('teamSelect','teamDropdown','Select Teams');
  initMultiDrop('monthSelect','monthDropdown','Select Months');

  /* ============================================
     INITIAL RENDER
     ============================================ */
  renderSelectedMonths();

  /* ============================================
     DOWNLOAD FUNCTIONALITY
     ============================================ */
  async function downloadMonthAsImage(year, month, teams) {
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1200px';
    tempContainer.style.background = '#ffffff';
    tempContainer.style.padding = '40px';
    tempContainer.style.fontFamily = 'Tahoma, sans-serif';
    document.body.appendChild(tempContainer);

    const header = document.createElement('div');
    header.style.marginBottom = '30px';
    header.style.textAlign = 'center';
    header.innerHTML = `<h1 style="margin: 0; font-size: 36px; font-weight: 700; color: #111827;">${monthName(month).toUpperCase()} ${year}</h1>`;
    tempContainer.appendChild(header);

    const weekdayHeader = document.createElement('div');
    weekdayHeader.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 10px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;';
    weekdayHeader.innerHTML = `
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">SUN</div>
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">MON</div>
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">TUE</div>
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">WED</div>
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">THU</div>
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">FRI</div>
      <div style="padding: 12px; text-align: center; font-size: 14px; font-weight: 500; color: #6b7280;">SAT</div>
    `;
    tempContainer.appendChild(weekdayHeader);

    const calendarGrid = document.createElement('div');
    calendarGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;';
    calendarGrid.innerHTML = renderMonthGrid(year, month, teams);
    tempContainer.appendChild(calendarGrid);

    await new Promise(resolve => setTimeout(resolve, 200));

    try {
      const canvas = await html2canvas(tempContainer, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true,
        allowTaint: true,
      });

      return canvas;
    } finally {
      document.body.removeChild(tempContainer);
    }
  }

  /* ============================================
     MODAL: SHOW/HIDE FUNCTIONS
     ============================================ */
  function showDownloadModal() {
    const months = getSelectedMonths();
    const teams = getSelectedTeams();

    if (months.length === 0) {
      alert('Please select at least one month to download.');
      return;
    }

    const modal = document.getElementById('downloadModal');
    const teamValue = document.getElementById('modalTeamValue');
    const monthValue = document.getElementById('modalMonthValue');
    const bodyContent = document.getElementById('modalBodyContent');
    const loading = document.getElementById('modalLoading');
    const footer = document.getElementById('modalFooter');
    
    bodyContent.style.display = 'block';
    loading.classList.remove('visible');
    footer.style.display = 'flex';
    
    teamValue.textContent = teams.map(t => t.toUpperCase()).join(', ');
    monthValue.textContent = months.map(m => monthName(m)).join(', ');
    
    modal.style.display = 'flex';
  }

  function closeDownloadModal() {
    document.getElementById('downloadModal').style.display = 'none';
  }

  /* ============================================
     MODAL: DOWNLOAD HANDLER
     ============================================ */
  async function handleDownload() {
    const months = getSelectedMonths();
    const teams = getSelectedTeams();
    const bodyContent = document.getElementById('modalBodyContent');
    const loading = document.getElementById('modalLoading');
    const footer = document.getElementById('modalFooter');
    const progressText = document.getElementById('modalProgress');
    const downloadBtn = document.getElementById('downloadBtn');
    
    bodyContent.style.display = 'none';
    footer.style.display = 'none';
    loading.classList.add('visible');
    
    downloadBtn.disabled = true;

    try {
      for (let i = 0; i < months.length; i++) {
        progressText.textContent = `Processing image ${i + 1} of ${months.length}`;
        
        const canvas = await downloadMonthAsImage(MIN_YEAR, months[i], teams);
        
        const teamNames = teams.map(t => t.toUpperCase()).join('-');
        const monthName_str = monthName(months[i]);
        const fileName = `${teamNames}_${monthName_str}_${MIN_YEAR}.png`;
        
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
        
        if (i < months.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
      alert('Error downloading image. Please try again.');
    } finally {
      downloadBtn.disabled = false;
      closeDownloadModal();
    }
  }

  /* ============================================
     MODAL: EVENT LISTENERS
     ============================================ */
  document.getElementById('downloadBtn').addEventListener('click', showDownloadModal);
  document.getElementById('modalClose').addEventListener('click', closeDownloadModal);
  document.getElementById('modalCancel').addEventListener('click', closeDownloadModal);
  document.getElementById('modalConfirm').addEventListener('click', handleDownload);

  document.getElementById('downloadModal').addEventListener('click', (e) => {
    if (e.target.id === 'downloadModal') {
      closeDownloadModal();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeDownloadModal();
    }
  });
</script>
</body>
</html>