<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIFT SCHEDULE 2026</title>
    <style>
        :root {
            --header-height: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            overflow-y: scroll;
        }

        .container {
            max-width: 90rem;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.3);
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
            flex-wrap: nowrap;
        }

        .navigation {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            justify-self: center;
        }

        .filters {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            justify-self: flex-start;
            height: 100%;
            padding-left: 0.25rem;
        }

        .download-area {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.25rem;
        }

        .nav-button {
            /* kept for backwards compatibility; visuals come from .btn */
        }

        .nav-button:hover {}

        .month-year {
            color: #333;
            text-align: center;
            min-width: 7.5rem;
            font-size: inherit;
        }

        .download-button {
            /* kept for backwards compatibility */
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-button {
            /* shared styles with .btn, but can be overridden if needed */
            padding: 0.45rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: inherit;
            font-family: inherit;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
            border-radius: 0.4rem;
            padding: 0.25rem;
            margin-top: 0.4rem;
            display: none;
            z-index: 20;
            min-width: 9rem;
            overflow: auto;
        }

        .dropdown.open .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            border-radius: 0.25rem;
        }

        .dropdown-item:hover {
            background: #f1f5f9;
        }

        .dropdown-item .tick {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #cbd5e1;
            background: #fff;
            color: transparent;
            margin-right: 0.8rem;
            box-sizing: border-box;
            cursor: pointer;
            user-select: none;
        }

        .dropdown-item.selected .tick {
            background: #2b6cb0;
            border-color: #2b6cb0;
            color: #fff;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .calendar thead th {
            position: sticky;
            top: calc(var(--header-height));
            z-index: 35;
            background: #667eea;
            color: white;
            padding: 0.75rem;
            text-align: center;
        }

        .calendar th,
        .calendar td {
            width: calc(100% / 7);
        }

        .calendar td {
            border: 0.0625rem solid #ddd;
            padding: 0.5rem;
            vertical-align: top;
            min-height: 8rem;
        }

        .day-number {
            margin-bottom: 0.5rem;
            color: #333;
            text-align: center;
        }

        .team-schedule {
            margin-bottom: 0.3rem;
            padding: 0.3rem;
            border-radius: 0.25rem;
        }

        .team-name {
            display: block;
        }

        .shift-time {
            display: block;
        }

        .shift-0000-0800 {
            background: #4a5568;
            color: white;
        }

        .shift-0800-1600 {
            background: #48bb78;
            color: white;
        }

        .shift-1600-0000 {
            background: #ed8936;
            color: white;
        }

        .shift-off {
            background: #e2e8f0;
            color: #4a5568;
        }

        .shift-rest {
            background: #e2e8f0;
            color: #4a5568;
        }

        .empty-day {
            background: #f7fafc;
        }

        @media (max-width: 48rem) {
            .month-year {
                font-size: 1.1rem;
            }

            .nav-button {
                padding: 0.5rem 0.8rem;
                font-size: 0.9rem;
            }

            .calendar thead th {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            .calendar td {
                padding: 0.3rem;
                font-size: 0.7rem;
            }

            .day-number {
                font-size: 0.9rem;
                margin-bottom: 0.3rem;
            }

            .team-schedule {
                padding: 0.2rem;
                margin-bottom: 0.2rem;
                font-size: 0.65rem;
            }

            .shift-time {
                font-size: 0.6rem;
            }

            .download-button {
                padding: 0.35rem 0.6rem;
                font-size: 0.85rem;
            }

            /* --- Responsive media queries for modals --- */
            .modal {
                width: 70vw;
                max-height: 80vh;
            }

            .preview-modal {
                width: 95vw;
                max-height: 90vh;
            }

            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
                gap: 0.75rem;
            }

            .modal-title {
                font-size: 0.95rem;
            }

            .download-summary-row {
                font-size: 0.85rem;
            }

            .preview-item-label {
                font-size: 0.8rem;
                padding: 0.4rem;
            }

            .btn {
                padding: 0.4rem 0.55rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 30rem) {
            .container {
                padding: 0.75rem;
            }

            .header {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .navigation,
            .filters,
            .download-area {
                justify-content: center;
                padding: 0;
            }

            .team-schedule {
                font-size: 0.55rem;
                padding: 0.15rem;
            }

            .shift-time {
                font-size: 0.5rem;
            }

            .modal {
                width: 90vw;
                max-height: 85vh;
            }

            .preview-modal {
                width: 98vw;
                max-height: 92vh;
            }

            .preview-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .modal-header,
            .preview-modal-header {
                padding: 0.75rem;
            }

            .modal-body,
            .preview-modal-body {
                padding: 0.75rem;
            }

            .modal-footer,
            .preview-modal-footer {
                padding: 0.5rem 0.75rem;
                gap: 0.4rem;
            }

            .modal-title {
                font-size: 0.9rem;
            }

            .download-summary-row {
                font-size: 0.8rem;
                padding-left: 0.15rem;
            }

            .list-stack .dropdown-item {
                padding: 0.35rem 0.5rem;
                font-size: 0.85rem;
            }

            .dropdown-item .tick {
                width: 1.1rem;
                height: 1.1rem;
                margin-right: 0.6rem;
            }

            .preview-item-label {
                font-size: 0.75rem;
                padding: 0.35rem;
            }

            .btn {
                padding: 0.35rem 0.5rem;
                font-size: 0.85rem;
            }

            .download-actions {
                gap: 0.5rem;
            }

            .preview-modal-footer {
                gap: 0.5rem;
            }
        }

        @media (max-width: 20rem) {
            .modal {
                width: 95vw;
                max-height: 90vh;
            }

            .preview-modal {
                width: 100vw;
                max-height: 95vh;
                border-radius: 0;
            }

            .modal-title {
                font-size: 0.85rem;
            }

            .download-summary-row {
                font-size: 0.75rem;
            }

            .list-stack .dropdown-item {
                padding: 0.3rem 0.4rem;
                font-size: 0.8rem;
            }

            .btn {
                padding: 0.3rem 0.45rem;
                font-size: 0.8rem;
            }

            .btn-ghost {
                padding: 0.25rem;
            }
        }

        /* --- Download confirmation modal styles --- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-backdrop.open {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 0.75rem;
            width: 25vw;
            max-height: 70vh;
            /* make modal a column so header/body/footer can behave independently */
            display: flex;
            flex-direction: column;
            overflow: auto;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.35);
            padding: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            /* sticky at top of the modal scrolling area */
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 1rem;
            background: #fff;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .modal-title {
            font-weight: 700;
        }

        .modal-body {
            /* body scrolls inside modal; header/footer remain visible */
            flex: 1 1 auto;
            overflow: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-footer {
            display: flex;
            flex-direction: column;
            /* stack into three rows: team, month, actions */
            align-items: stretch;
            gap: 0.5rem;
            /* sticky at bottom of the modal scrolling area */
            position: sticky;
            bottom: 0;
            z-index: 20;
            padding: 0.75rem 1rem;
            background: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .download-summary-row {
            color: #374151;
            font-size: 0.95rem;
            padding-left: 0.25rem;
            overflow: hidden;
        }

        .download-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* shared stacked list style for both team and month choices */
        .list-stack {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding-right: 0.25rem;
            /* no internal scrolling — modal scrolls as a whole */
            max-height: none;
            overflow: visible;
        }

        /* dropdown-item already used for each row (tick + label) — ensure full width */
        .list-stack .dropdown-item {
            width: 100%;
            padding: 0.45rem 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #e6e6e6;
            background: #fafafa;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            justify-content: flex-start;
        }

        /* Shared button base */
        .btn {
            padding: 0.45rem 0.6rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: inherit;
            font-family: inherit;
            transition: background 0.2s, color 0.2s;
            background: #f3f4f6;
            color: #111827;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            color: #9ca3af;
        }

        /* Variants */
        .btn-primary {
            background: #10b981;
            color: #fff;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #e6e7ea;
            color: #111827;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid transparent;
        }

        .download-summary {
            margin-right: auto;
            padding-left: 0.5rem;
            color: #374151;
            font-size: 0.95rem;
            align-self: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 40ch;
        }

        /* Keep specific small tweaks for nav & dropdown visual needs if needed */
        .nav-button {
            min-width: 2.5rem;
            padding: 0.35rem 0.55rem;
        }

        .dropdown-button {
            border: 1px solid #ccc;
            background: #fff;
            padding: 0.4rem 0.6rem;
        }

        /* --- Preview modal styles --- */
        .preview-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 110;
            padding: 1rem;
        }

        .preview-modal-backdrop.open {
            display: flex;
        }

        .preview-modal {
            background: #fff;
            border-radius: 0.75rem;
            width: 90vw;
            max-width: 60rem;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.35);
        }

        .preview-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .preview-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(15rem, 1fr));
            gap: 1rem;
        }

        .preview-item {
            background: #f9fafb;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .preview-item:hover {
            transform: scale(1.02);
        }

        .preview-item canvas {
            width: 100%;
            display: block;
        }

        .preview-item-label {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #374151;
            background: white;
        }

        .preview-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        /* --- Responsive media queries for modals --- */
        @media (max-width: 48rem) {
            .modal {
                width: 70vw;
                max-height: 80vh;
            }

            .preview-modal {
                width: 95vw;
                max-height: 90vh;
            }

            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
                gap: 0.75rem;
            }

            .modal-title {
                font-size: 0.95rem;
            }

            .download-summary-row {
                font-size: 0.85rem;
            }

            .preview-item-label {
                font-size: 0.8rem;
                padding: 0.4rem;
            }

            .btn {
                padding: 0.4rem 0.55rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 30rem) {
            .container {
                padding: 0.75rem;
            }

            .header {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .navigation,
            .filters,
            .download-area {
                justify-content: center;
                padding: 0;
            }

            .team-schedule {
                font-size: 0.55rem;
                padding: 0.15rem;
            }

            .shift-time {
                font-size: 0.5rem;
            }

            .modal {
                width: 90vw;
                max-height: 85vh;
            }

            .preview-modal {
                width: 98vw;
                max-height: 92vh;
            }

            .preview-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .modal-header,
            .preview-modal-header {
                padding: 0.75rem;
            }

            .modal-body,
            .preview-modal-body {
                padding: 0.75rem;
            }

            .modal-footer,
            .preview-modal-footer {
                padding: 0.5rem 0.75rem;
                gap: 0.4rem;
            }

            .modal-title {
                font-size: 0.9rem;
            }

            .download-summary-row {
                font-size: 0.8rem;
                padding-left: 0.15rem;
            }

            .list-stack .dropdown-item {
                padding: 0.35rem 0.5rem;
                font-size: 0.85rem;
            }

            .dropdown-item .tick {
                width: 1.1rem;
                height: 1.1rem;
                margin-right: 0.6rem;
            }

            .preview-item-label {
                font-size: 0.75rem;
                padding: 0.35rem;
            }

            .btn {
                padding: 0.35rem 0.5rem;
                font-size: 0.85rem;
            }

            .download-actions {
                gap: 0.5rem;
            }

            .preview-modal-footer {
                gap: 0.5rem;
            }
        }

        @media (max-width: 20rem) {
            .modal {
                width: 95vw;
                max-height: 90vh;
            }

            .preview-modal {
                width: 100vw;
                max-height: 95vh;
                border-radius: 0;
            }

            .modal-title {
                font-size: 0.85rem;
            }

            .download-summary-row {
                font-size: 0.75rem;
            }

            .list-stack .dropdown-item {
                padding: 0.3rem 0.4rem;
                font-size: 0.8rem;
            }

            .btn {
                padding: 0.3rem 0.45rem;
                font-size: 0.8rem;
            }

            .btn-ghost {
                padding: 0.25rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="filters" role="region" aria-label="filters">
                <div class="dropdown" id="teamDropdown">
                    <button class="dropdown-button" id="teamDropdownBtn">Select Teams</button>
                    <div class="dropdown-menu" id="teamDropdownMenu"></div>
                </div>
            </div>

            <div class="navigation" aria-label="month navigation">
                <button class="btn nav-button" id="prevBtn" onclick="changeMonth(-1)"></button>
                <div class="month-year" id="monthYear"></div>
                <button class="btn nav-button" id="nextBtn" onclick="changeMonth(1)"></button>
            </div>

            <div class="download-area">
                <button id="downloadBtn" class="btn download-button">Download</button>
            </div>
        </div>

        <!-- Download confirmation modal (module) -->
        <div class="modal-backdrop" id="downloadModal" aria-hidden="true" role="dialog" aria-modal="true">
            <div class="modal" role="document" aria-labelledby="downloadModalTitle">
                <div class="modal-header">
                    <div class="modal-title" id="downloadModalTitle">Download schedule as image</div>
                </div>

                <div class="modal-body">
                    <div>
                        <strong>Choose teams</strong>
                        <div style="margin-top:0.5rem;">
                            <div class="dropdown-item" id="downloadSelectAllItem"><span class="tick">✓</span><span>Select all</span>
                            </div>
                        </div>
                        <div class="list-stack" id="downloadTeamList" style="margin-top:0.5rem;"></div>
                    </div>

                    <div>
                        <strong>Choose month</strong>
                        <div style="margin-top:0.5rem;">
                            <div class="dropdown-item" id="downloadMonthSelectAllItem"><span class="tick">✓</span><span>Select all</span>
                            </div>
                        </div>
                        <!-- use the exact same classes/styles as the team list -->
                        <div class="list-stack" id="downloadMonthList" style="margin-top:0.5rem;"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <!-- row 1: team summary -->
                    <div id="downloadSummaryTeam" class="download-summary-row">Team: None</div>
                    <!-- row 2: month summary -->
                    <div id="downloadSummaryMonth" class="download-summary-row">Month: None</div>
                    <!-- row 3: buttons -->
                    <div class="download-actions">
                        <button id="cancelDownloadBtn" class="btn btn-secondary">Cancel</button>
                        <button id="confirmDownloadBtn" class="btn btn-primary">Confirm & Prepare</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="preview-modal-backdrop" id="previewModal">
            <div class="preview-modal">
                <div class="preview-modal-header">
                    <div class="modal-title">Preview Calendar Images</div>
                    <button class="btn btn-ghost" id="closePreviewBtn">✕</button>
                </div>
                <div class="preview-modal-body">
                    <div class="preview-grid" id="previewGrid"></div>
                </div>
                <div class="preview-modal-footer">
                    <button class="btn btn-secondary" id="backToSelectBtn">Back</button>
                    <button class="btn btn-primary" id="downloadAllBtn">Download All</button>
                </div>
            </div>
        </div>

        <table class="calendar" id="calendar"></table>
    </div>

    <script>
        const teams = ['SITI', 'IRA', 'EKIN', 'BALQIS'];
        const shifts = ['0800-1600', '0000-0800', '1600-0000'];
        const shiftNames = {
            '0000-0800': 'Night',
            '0800-1600': 'Morning',
            '1600-0000': 'Evening'
        };

        const today = new Date();
        const MIN_YEAR = 2026,
            MAX_YEAR = 2026;
        const MIN_MONTH = 0,
            MAX_MONTH = 11;

        // Initialize to current date
        let currentMonth = today.getMonth(); // 0-11
        let currentYear = today.getFullYear();

        // Clamp to valid range [Jan 2026 - Dec 2026]
        const minDate = new Date(MIN_YEAR, MIN_MONTH, 1);
        const maxDate = new Date(MAX_YEAR, MAX_MONTH, 1);
        const currentDate = new Date(currentYear, currentMonth, 1);

        if (currentDate < minDate) {
            // Before Jan 2026 - show Jan 2026
            currentYear = MIN_YEAR;
            currentMonth = MIN_MONTH;
        } else if (currentDate > maxDate) {
            // After Dec 2026 - show Dec 2026
            currentYear = MAX_YEAR;
            currentMonth = MAX_MONTH;
        }
        // else: current date is within range, use it as is

        let selectedTeams = [...teams];

        const initialState = {
            'SITI': { shift: '1600-0000', dayInCycle: 5 },
            'IRA': { shift: 'off', dayInCycle: 7 },
            'EKIN': { shift: '0800-1600', dayInCycle: 3 },
            'BALQIS': { shift: '0000-0800', dayInCycle: 1 }
        };

        function getScheduleForDate(date) {
            const jan1_2026 = new Date(2026, 0, 1);
            const daysDiff = Math.floor((date - jan1_2026) / (1000 * 60 * 60 * 24));
            const schedule = {};

            for (const team of teams) {
                const initial = initialState[team];
                let dayInCycle = initial.dayInCycle + daysDiff;
                dayInCycle = ((dayInCycle - 1) % 8) + 1;

                if (dayInCycle === 7) {
                    schedule[team] = { shift: 'off', dayInCycle: 7 };
                } else if (dayInCycle === 8) {
                    schedule[team] = { shift: 'rest', dayInCycle: 8 };
                } else {
                    let currentShift;

                    if (team === 'SITI') {
                        const workCyclesPassed = Math.floor((daysDiff + initial.dayInCycle - 1) / 8);
                        const shiftIndex = (2 + workCyclesPassed) % 3;
                        currentShift = shifts[shiftIndex];
                    } else if (team === 'IRA') {
                        const adjustedDays = daysDiff - 2;
                        if (adjustedDays < 0) {
                            if (dayInCycle === 7) currentShift = 'off';
                            else if (dayInCycle === 8) currentShift = 'rest';
                        } else {
                            const workCyclesPassed = Math.floor((adjustedDays) / 8);
                            const shiftIndex = (2 + workCyclesPassed) % 3;
                            currentShift = shifts[shiftIndex];
                        }
                    } else if (team === 'EKIN') {
                        const workCyclesPassed = Math.floor((daysDiff + initial.dayInCycle - 1) / 8);
                        const shiftIndex = (0 + workCyclesPassed) % 3;
                        currentShift = shifts[shiftIndex];
                    } else if (team === 'BALQIS') {
                        const workCyclesPassed = Math.floor((daysDiff + initial.dayInCycle - 1) / 8);
                        const shiftIndex = (1 + workCyclesPassed) % 3;
                        currentShift = shifts[shiftIndex];
                    }

                    schedule[team] = { shift: currentShift, dayInCycle: dayInCycle };
                }
            }

            return schedule;
        }

        function updateHeaderHeight() {
            const hdr = document.querySelector('.header');
            const h = hdr ? Math.ceil(hdr.getBoundingClientRect().height) : 0;
            document.documentElement.style.setProperty('--header-height', `${h}px`);
        }

        function generateCalendar() {
            const calendar = document.querySelector('#calendar');
            const monthYear = document.querySelector('#monthYear');
            const prevBtn = document.querySelector('#prevBtn');
            const nextBtn = document.querySelector('#nextBtn');
            const minDate = new Date(MIN_YEAR, MIN_MONTH, 1);
            const maxDate = new Date(MAX_YEAR, MAX_MONTH, 1);

            const teamsToShow = selectedTeams.length ? selectedTeams : [...teams];

            const date = new Date(currentYear, currentMonth, 1);
            const monthName = date.toLocaleString('en-US', { month: 'long' });
            monthYear.textContent = `${monthName} ${currentYear}`;

            const prevDate = new Date(currentYear, currentMonth - 1, 1);
            const nextDate = new Date(currentYear, currentMonth + 1, 1);
            prevBtn.textContent = '◀';
            nextBtn.textContent = '▶';
            prevBtn.disabled = prevDate < minDate;
            nextBtn.disabled = nextDate > maxDate;

            calendar.innerHTML = '';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            for (const day of daysOfWeek) {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            calendar.appendChild(thead);

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const tbody = document.createElement('tbody');

            let dayCount = 1;
            let rowCount = Math.ceil((firstDay + daysInMonth) / 7);

            for (let i = 0; i < rowCount; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');

                    if (i === 0 && j < firstDay) {
                        cell.classList.add('empty-day');
                    } else if (dayCount > daysInMonth) {
                        cell.classList.add('empty-day');
                    } else {
                        const currentDate = new Date(currentYear, currentMonth, dayCount);
                        const schedule = getScheduleForDate(currentDate);
                        const dayNumber = document.createElement('div');
                        dayNumber.className = 'day-number';
                        dayNumber.textContent = dayCount;
                        cell.appendChild(dayNumber);

                        for (const team of teamsToShow) {
                            const teamDiv = document.createElement('div');
                            teamDiv.className = 'team-schedule';
                            const shift = schedule[team].shift;
                            teamDiv.classList.add(`shift-${shift.replace(':', '')}`);

                            const teamName = document.createElement('span');
                            teamName.className = 'team-name';
                            teamName.textContent = team;
                            teamDiv.appendChild(teamName);

                            const shiftTime = document.createElement('span');
                            shiftTime.className = 'shift-time';
                            shiftTime.textContent = shift === 'off' ? 'Off Day' : shift === 'rest' ? 'Rest Day' : (shiftNames[shift] || shift);
                            teamDiv.appendChild(shiftTime);

                            const dayInCycle = schedule[team].dayInCycle;
                            if (shift !== 'off' && shift !== 'rest') {
                                const kerjaInfo = document.createElement('span');
                                kerjaInfo.className = 'shift-time';
                                kerjaInfo.textContent = `Day ${dayInCycle}`;
                                teamDiv.appendChild(kerjaInfo);
                            }
                            cell.appendChild(teamDiv);
                        }
                        dayCount++;
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
            calendar.appendChild(tbody);
            setTimeout(updateHeaderHeight, 0);
        }

        function changeMonth(direction) {
            const candidate = new Date(currentYear, currentMonth + direction, 1);
            const minDate = new Date(MIN_YEAR, MIN_MONTH, 1);
            const maxDate = new Date(MAX_YEAR, MAX_MONTH, 1);
            if (candidate < minDate || candidate > maxDate) return;
            currentYear = candidate.getFullYear();
            currentMonth = candidate.getMonth();
            generateCalendar();
        }

        function populateFilters() {
            const teamMenu = document.getElementById('teamDropdownMenu');
            const teamBtn = document.getElementById('teamDropdownBtn');

            teamMenu.innerHTML = '';

            const teamAll = document.createElement('div');
            teamAll.className = 'dropdown-item' + (selectedTeams.length === teams.length ? ' selected' : '');
            teamAll.innerHTML = `<span class="tick">✓</span><span>Select All</span>`;
            teamAll.addEventListener('click', (e) => {
                e.stopPropagation();
                selectedTeams = selectedTeams.length === teams.length ? [] : [...teams];
                populateFilters();
                generateCalendar();
            });
            teamMenu.appendChild(teamAll);

            for (const t of teams) {
                const item = document.createElement('div');
                item.className = 'dropdown-item' + (selectedTeams.includes(t) ? ' selected' : '');
                item.innerHTML = `<span class="tick">✓</span><span>${t}</span>`;
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = selectedTeams.indexOf(t);
                    if (idx === -1) selectedTeams.push(t);
                    else selectedTeams.splice(idx, 1);
                    populateFilters();
                    generateCalendar();
                });
                teamMenu.appendChild(item);
            }

            const teamDropdown = document.getElementById('teamDropdown');

            teamBtn.onclick = (e) => {
                e.stopPropagation();
                const opened = teamDropdown.classList.toggle('open');
                setTimeout(updateHeaderHeight, 0);
            };
        }

        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            setTimeout(updateHeaderHeight, 0);
        });

        window.addEventListener('resize', updateHeaderHeight);
        window.addEventListener('load', updateHeaderHeight);

        populateFilters();
        generateCalendar();
        setTimeout(updateHeaderHeight, 0);

        // --- Download modal logic (module) ---
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadModal = document.getElementById('downloadModal');
        const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
        const confirmDownloadBtn = document.getElementById('confirmDownloadBtn');
        const downloadTeamList = document.getElementById('downloadTeamList');
        const downloadSelectAllItem = document.getElementById('downloadSelectAllItem');
        const downloadMonthSelectAllItem = document.getElementById('downloadMonthSelectAllItem');
        const downloadMonthList = document.getElementById('downloadMonthList');

        // modal-local selections (start unselected by default)
        let downloadSelectedMonths = [];
        let downloadSelectedTeams = [];

        function openDownloadModal() {
            // reset modal selections (unselect all by default)
            downloadSelectedTeams = [];
            downloadSelectedMonths = [];
            populateDownloadTeams();
            populateDownloadMonths();
            updateDownloadMonthSelectAllState();
            updateDownloadSelectAllState();
            // ensure confirm disabled until at least one team AND one month selected
            updateConfirmButtonState();

            // open modal, make it focusable/inert handling for accessibility
            downloadModal.classList.add('open');
            downloadModal.removeAttribute('aria-hidden');
            downloadModal.removeAttribute('inert');
            setTimeout(() => {
                updateHeaderHeight();
                // focus first focusable inside modal (prefer confirm button)
                const first = downloadModal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (first) first.focus();
            }, 0);
        }

        function closeDownloadModalFn() {
            // move focus out of modal before hiding to avoid aria-hidden focus blocking
            try {
                if (downloadModal.contains(document.activeElement)) downloadBtn.focus();
            } catch (e) { /* ignore */ }
            downloadModal.classList.remove('open');
            downloadModal.setAttribute('aria-hidden', 'true');
            // make backdrop inert so it and descendants are removed from the accessibility tree
            downloadModal.setAttribute('inert', '');
            setTimeout(updateHeaderHeight, 0);
        }

        function populateDownloadTeams() {
            downloadTeamList.innerHTML = '';
            for (const t of teams) {
                const el = document.createElement('div');
                el.className = 'dropdown-item' + (downloadSelectedTeams.includes(t) ? ' selected' : '');
                el.dataset.value = t;
                el.innerHTML = `<span class="tick">✓</span><span>${t}</span>`;
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isSelected = el.classList.toggle('selected');
                    if (isSelected) {
                        if (!downloadSelectedTeams.includes(t)) downloadSelectedTeams.push(t);
                    } else {
                        downloadSelectedTeams = downloadSelectedTeams.filter(x => x !== t);
                    }
                    updateDownloadSelectAllState();
                });
                downloadTeamList.appendChild(el);
            }
            updateDownloadSelectAllState();
        }

        function updateDownloadSelectAllState() {
            const items = Array.from(downloadTeamList.querySelectorAll('.dropdown-item'));
            const selected = items.filter(i => i.classList.contains('selected'));
            downloadSelectAllItem.classList.toggle('selected', items.length > 0 && selected.length === items.length);
            updateConfirmButtonState();
            updateDownloadSummary();
        }

        downloadSelectAllItem.addEventListener('click', (e) => {
            e.stopPropagation();
            const items = Array.from(downloadTeamList.querySelectorAll('.dropdown-item'));
            const allSelected = downloadSelectAllItem.classList.contains('selected');
            items.forEach(i => i.classList.toggle('selected', !allSelected));
            // sync modal-local selection
            downloadSelectedTeams = allSelected ? [] : items.map(i => i.dataset.value);
            updateDownloadSelectAllState();
            updateDownloadSummary();
        });

        function populateDownloadMonths() {
            downloadMonthList.innerHTML = '';
            for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
                for (let m = 0; m < 12; m++) {
                    const candidate = new Date(y, m, 1);
                    const minD = new Date(MIN_YEAR, MIN_MONTH, 1);
                    const maxD = new Date(MAX_YEAR, MAX_MONTH, 1);
                    if (candidate < minD || candidate > maxD) continue;
                    const val = `${y}-${String(m + 1).padStart(2, '0')}`;
                    // show only first 3 letters of month (no year)
                    const label = candidate.toLocaleString('en-US', { month: 'short' });
                    const it = document.createElement('div');
                    it.className = 'dropdown-item' + (downloadSelectedMonths.includes(val) ? ' selected' : '');
                    it.dataset.value = val;
                    it.innerHTML = `<span class="tick">✓</span><span>${label}</span>`;
                    it.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // toggle selection for months (multi-select)
                        const isSelected = it.classList.toggle('selected');
                        if (isSelected) {
                            if (!downloadSelectedMonths.includes(val)) downloadSelectedMonths.push(val);
                        } else {
                            downloadSelectedMonths = downloadSelectedMonths.filter(x => x !== val);
                        }
                        updateDownloadMonthSelectAllState();
                    });
                    downloadMonthList.appendChild(it);
                }
            }
            updateDownloadMonthSelectAllState();
        }

        function updateDownloadMonthSelectAllState() {
            const items = Array.from(downloadMonthList.querySelectorAll('.dropdown-item'));
            if (items.length === 0) {
                downloadMonthSelectAllItem.classList.remove('selected');
                updateConfirmButtonState();
                updateDownloadSummary();
                return;
            }
            const allSelected = items.every(i => downloadSelectedMonths.includes(i.dataset.value));
            downloadMonthSelectAllItem.classList.toggle('selected', allSelected);
            updateConfirmButtonState();
            updateDownloadSummary();
        }

        downloadMonthSelectAllItem.addEventListener('click', (e) => {
            e.stopPropagation();
            const items = Array.from(downloadMonthList.querySelectorAll('.dropdown-item'));
            const allSelected = downloadMonthSelectAllItem.classList.contains('selected');
            if (allSelected) {
                // deselect all
                items.forEach(i => i.classList.remove('selected'));
                downloadSelectedMonths = [];
            } else {
                // select all
                items.forEach(i => i.classList.add('selected'));
                downloadSelectedMonths = items.map(i => i.dataset.value);
            }
            updateDownloadMonthSelectAllState();
            updateDownloadSummary();
        });

        downloadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openDownloadModal();
        });
        cancelDownloadBtn.addEventListener('click', (e) => { e.stopPropagation(); closeDownloadModalFn(); });

        confirmDownloadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chosenTeams = downloadSelectedTeams;
            const chosenMonths = downloadSelectedMonths;
            closeDownloadModalFn();
            // Generate and show preview
            generateCalendarPreviews(chosenTeams, chosenMonths);
        });

        function generateCalendarPreviews(teams, months) {
            const previewModal = document.getElementById('previewModal');
            const previewGrid = document.getElementById('previewGrid');

            previewGrid.innerHTML = '';

            months.forEach(monthVal => {
                const [year, month] = monthVal.split('-');
                const canvas = createCalendarCanvas(parseInt(year), parseInt(month) - 1, teams);

                const item = document.createElement('div');
                item.className = 'preview-item';

                const label = document.createElement('div');
                label.className = 'preview-item-label';
                const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                label.textContent = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                item.appendChild(canvas);
                item.appendChild(label);

                item.addEventListener('click', () => {
                    downloadCanvas(canvas, `schedule-${monthVal}.png`);
                });

                previewGrid.appendChild(item);
            });

            previewModal.classList.add('open');
        }

        function createCalendarCanvas(year, month, teams) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = 800;
            canvas.height = 900;

            // Background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Header
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, canvas.width, 60);

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            const date = new Date(year, month, 1);
            const monthName = date.toLocaleString('en-US', { month: 'long' });
            ctx.fillText(`${monthName} ${year}`, canvas.width / 2, 38);

            // Days of week header
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const cellWidth = canvas.width / 7;
            const headerY = 80;

            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = '#333333';
            days.forEach((day, i) => {
                ctx.textAlign = 'center';
                ctx.fillText(day, cellWidth * i + cellWidth / 2, headerY);
            });

            // Calendar grid
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const cellHeight = 120;
            let dayCount = 1;
            const startY = 100;

            for (let week = 0; week < 6 && dayCount <= daysInMonth; week++) {
                for (let day = 0; day < 7; day++) {
                    if (week === 0 && day < firstDay) continue;
                    if (dayCount > daysInMonth) break;

                    const x = day * cellWidth;
                    const y = startY + week * cellHeight;

                    // Cell border
                    ctx.strokeStyle = '#dddddd';
                    ctx.strokeRect(x, y, cellWidth, cellHeight);

                    // Day number
                    ctx.fillStyle = '#333333';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(dayCount, x + 8, y + 18);

                    // Get schedule for this day
                    const currentDate = new Date(year, month, dayCount);
                    const schedule = getScheduleForDate(currentDate);

                    // Draw team schedules
                    let offsetY = 35;
                    const teamHeight = (cellHeight - 40) / teams.length;

                    teams.forEach((team, idx) => {
                        const shift = schedule[team].shift;
                        const teamY = y + offsetY + idx * teamHeight;

                        // Background color
                        let bgColor = '#e2e8f0';
                        if (shift === '0000-0800') bgColor = '#4a5568';
                        else if (shift === '0800-1600') bgColor = '#48bb78';
                        else if (shift === '1600-0000') bgColor = '#ed8936';

                        ctx.fillStyle = bgColor;
                        ctx.fillRect(x + 4, teamY, cellWidth - 8, teamHeight - 2);

                        // Team name and shift
                        ctx.fillStyle = (shift === 'off' || shift === 'rest') ? '#4a5568' : '#ffffff';
                        ctx.font = 'bold 11px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(team, x + 8, teamY + 14);

                        ctx.font = '9px Arial';
                        const shiftText = shift === 'off' ? 'Off' : shift === 'rest' ? 'Rest' : (shiftNames[shift] || shift);
                        ctx.fillText(shiftText, x + 8, teamY + 26);
                    });

                    dayCount++;
                }
            }

            return canvas;
        }

        function downloadCanvas(canvas, filename) {
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        // Preview modal controls
        document.getElementById('closePreviewBtn').addEventListener('click', () => {
            document.getElementById('previewModal').classList.remove('open');
        });

        document.getElementById('backToSelectBtn').addEventListener('click', () => {
            document.getElementById('previewModal').classList.remove('open');
            openDownloadModal();
        });

        document.getElementById('downloadAllBtn').addEventListener('click', () => {
            const items = document.querySelectorAll('.preview-item canvas');
            items.forEach((canvas, idx) => {
                setTimeout(() => {
                    const monthVal = downloadSelectedMonths[idx];
                    downloadCanvas(canvas, `schedule-${monthVal}.png`);
                }, idx * 200);
            });
        });

        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                document.getElementById('previewModal').classList.remove('open');
            }
        });

        function updateConfirmButtonState() {
            // Enable confirm button only if at least one team AND one month selected
            const hasTeams = downloadSelectedTeams.length > 0;
            const hasMonths = downloadSelectedMonths.length > 0;
            confirmDownloadBtn.disabled = !(hasTeams && hasMonths);
        }

        function updateDownloadSummary() {
            const summaryTeam = document.getElementById('downloadSummaryTeam');
            const summaryMonth = document.getElementById('downloadSummaryMonth');

            // Team summary
            if (downloadSelectedTeams.length === 0) {
                summaryTeam.textContent = 'Team: None';
            } else if (downloadSelectedTeams.length === teams.length) {
                summaryTeam.textContent = 'Team: All teams';
            } else {
                summaryTeam.textContent = `Team: ${downloadSelectedTeams.join(', ')}`;
            }

            // Month summary
            if (downloadSelectedMonths.length === 0) {
                summaryMonth.textContent = 'Month: None';
            } else {
                const monthLabels = downloadSelectedMonths.map(val => {
                    const [year, month] = val.split('-');
                    const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                    return date.toLocaleString('en-US', { month: 'short' });
                });

                if (downloadSelectedMonths.length === 12) {
                    summaryMonth.textContent = 'Month: All months';
                } else {
                    summaryMonth.textContent = `Month: ${monthLabels.join(', ')}`;
                }
            }
        }
    </script>
</body>

</html>